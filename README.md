<!-- This file was automatically generated by the `geine`. Make all changes to `README.yaml` and run `make readme` to rebuild this file. -->

<p align="center"> <img src="https://user-images.githubusercontent.com/50652676/62349836-882fef80-b51e-11e9-99e3-7b974309c7e3.png" width="100" height="100"></p>


<h1 align="center">
    Terraform AZURE CONTAINER REGISTRY (ACR)


</h1>

<p align="center" style="font-size: 1.2rem;"> 
    Terraform module to create acr resource on AZURE.
     </p>

<p align="center">

<a href="https://www.terraform.io">
  <img src="https://img.shields.io/badge/Terraform-v1.0.0-green" alt="Terraform">
</a>
<a href="LICENSE.md">
  <img src="https://img.shields.io/badge/License-APACHE-blue.svg" alt="Licence">
</a>


</p>
<p align="center">

<a href='https://facebook.com/sharer/sharer.php?u=https://github.com/clouddrove/terraform-azure-acr'>
  <img title="Share on Facebook" src="https://user-images.githubusercontent.com/50652676/62817743-4f64cb80-bb59-11e9-90c7-b057252ded50.png" />
</a>
<a href='https://www.linkedin.com/shareArticle?mini=true&title=Terraform+AZURE+CONTAINER+REGISTRY+(ACR)&url=https://github.com/clouddrove/terraform-azure-acr'>
  <img title="Share on LinkedIn" src="https://user-images.githubusercontent.com/50652676/62817742-4e339e80-bb59-11e9-87b9-a1f68cae1049.png" />
</a>
<a href='https://twitter.com/intent/tweet/?text=Terraform+AZURE+CONTAINER+REGISTRY+(ACR)&url=https://github.com/clouddrove/terraform-azure-acr'>
  <img title="Share on Twitter" src="https://user-images.githubusercontent.com/50652676/62817740-4c69db00-bb59-11e9-8a79-3580fbbf6d5c.png" />
</a>

</p>
<hr>


We eat, drink, sleep and most importantly love **DevOps**. We are working towards strategies for standardizing architecture while ensuring security for the infrastructure. We are strong believer of the philosophy <b>Bigger problems are always solved by breaking them into smaller manageable problems</b>. Resonating with microservices architecture, it is considered best-practice to run database, cluster, storage in smaller <b>connected yet manageable pieces</b> within the infrastructure. 

This module is basically combination of [Terraform open source](https://www.terraform.io/) and includes automatation tests and examples. It also helps to create and improve your infrastructure with minimalistic code instead of maintaining the whole infrastructure code yourself.

We have [*fifty plus terraform modules*][terraform_modules]. A few of them are comepleted and are available for open source usage while a few others are in progress.




## Prerequisites

This module has a few dependencies: 






## Examples


**IMPORTANT:** Since the `master` branch used in `source` varies based on new modifications, we suggest that you use the release versions [here](https://github.com/clouddrove/terraform-azure-acr/releases).


### Basic Example
Here is an example of how you can use this module in your inventory structure:
```hcl
  module "container-registry" {
  source              = "../../"
  name                = local.name # Name used for specifying tags and other resources naming.(like private endpoint, vnet-link etc)
  environment         = local.environment
  resource_group_name = module.resource_group.resource_group_name
  location            = module.resource_group.resource_group_location
  container_registry_config = {
  name = "cdacr1234" # Name of Container Registry
  sku  = "Premium"
 }
 ##----------------------------------------------------------------------------- 
 ## To be mentioned for private endpoint, because private endpoint is enabled by default.
 ## To disable private endpoint set 'enable_private_endpoint' variable = false and than no need to specify following variable  
 ##-----------------------------------------------------------------------------
 virtual_network_id = "vnet_id"
 enable_diagnostic  = false
 }
```

### Complete Example
Here is an example of how you can use this module in your inventory structure:
```hcl
  module "container-registry" {
  source              = "../../"
  name                = local.name # Name used for specifying tags and other resources naming.(like private endpoint, vnet-link etc)
  environment         = local.environment
  resource_group_name = module.resource_group.resource_group_name
  location            = module.resource_group.resource_group_location
  container_registry_config = {
  name = "cdacr1234" # Name of Container Registry
  sku  = "Premium"
  }
  log_analytics_workspace_id = module.log-analytics.workspace_id
  ##----------------------------------------------------------------------------- 
  ## To be mentioned for private endpoint, because private endpoint is enabled by default.
  ## To disable private endpoint set 'enable_private_endpoint' variable = false and than no need to specify following variable  
  ##-----------------------------------------------------------------------------
  virtual_network_id = module.vnet.vnet_id
  subnet_id          = module.subnet.default_subnet_id[0]
  }
 ```

### with_existing_dns_zone_in_diff_rg
Here is an example of how you can use this module in your inventory structure:
```hcl
  module "container-registry" {
  source              = "../../"
  name                = local.name # Name used for specifying tags and other resources naming.(like private endpoint, vnet-link etc)
  environment         = local.environment
  resource_group_name = module.resource_group.resource_group_name
  location            = module.resource_group.resource_group_location
  container_registry_config = {
  name = "cdacr1234" # Name of Container Registry
  sku  = "Premium"
  }
  log_analytics_workspace_id = module.log-analytics.workspace_id
  ##----------------------------------------------------------------------------- 
  ## To be mentioned for private endpoint, because private endpoint is enabled by default.
  ## To disable private endpoint set 'enable_private_endpoint' variable = false and than no need to specify following variable  
  ##-----------------------------------------------------------------------------
  virtual_network_id = module.vnet.vnet_id
  subnet_id          = module.subnet.default_subnet_id[0]
  ##----------------------------------------------------------------------------- 
  ## Specify following variales when private dns zone is in same subscription but in different resource group
  ##-----------------------------------------------------------------------------
  existing_private_dns_zone                     = "privatelink.azurecr.io" # Name of private dns zone remain same for acr. 
  existing_private_dns_zone_resource_group_name = "example_test_rg"
  }
 ```
 
### with_existing_dns_zone_in_diff_subs
Here is an example of how you can use this module in your inventory structure:
```hcl
  module "container-registry" {
  ource              = "../../"
  name                = local.name # Name used for specifying tags and other resources naming.(like private endpoint, vnet-link etc)
  environment         = local.environment
  resource_group_name = module.resource_group.resource_group_name
  location            = module.resource_group.resource_group_location
  container_registry_config = {
  name = "cdacr1234" # Name of Container Registry
  sku  = "Premium"
  }
  log_analytics_workspace_id = module.log-analytics.workspace_id
  ##----------------------------------------------------------------------------- 
  ## To be mentioned for private endpoint, because private endpoint is enabled by default.
  ## To disable private endpoint set 'enable_private_endpoint' variable = false and than no need to specify following variable  
  ##-----------------------------------------------------------------------------
  virtual_network_id = module.vnet.vnet_id
  subnet_id          = module.subnet.default_subnet_id[0]
  ##----------------------------------------------------------------------------- 
  ## Specify following variales when private dns zone is in different subscription.
  ##-----------------------------------------------------------------------------
  diff_sub                                      = true
  alias_sub                                     = "35XXXXXXXXXXXX67"       # Subcription id in which dns zone is present.
  existing_private_dns_zone                     = "privatelink.azurecr.io" # Name of private dns zone remain same for acr. 
  existing_private_dns_zone_resource_group_name = "example_test_rg"
  }
 ```






## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| addon\_resource\_group\_name | The name of the addon vnet resource group | `string` | `""` | no |
| addon\_vent\_link | The name of the addon vnet | `bool` | `false` | no |
| addon\_virtual\_network\_id | The name of the addon vnet link vnet id | `string` | `""` | no |
| admin\_enabled | To enable of disable admin access | `bool` | `true` | no |
| alias\_sub | Subscription id for different sub in which dns zone is present. | `string` | `null` | no |
| azure\_services\_bypass | Whether to allow trusted Azure services to access a network restricted Container Registry? Possible values are None and AzureServices. Defaults to AzureServices | `string` | `"AzureServices"` | no |
| container\_registry\_config | Manages an Azure Container Registry | <pre>object({<br>    name                      = string<br>    sku                       = optional(string)<br>    quarantine_policy_enabled = optional(bool)<br>    zone_redundancy_enabled   = optional(bool)<br>  })</pre> | n/a | yes |
| container\_registry\_webhooks | Manages an Azure Container Registry Webhook | <pre>map(object({<br>    service_uri    = string<br>    actions        = list(string)<br>    status         = optional(string)<br>    scope          = string<br>    custom_headers = map(string)<br>  }))</pre> | `null` | no |
| diff\_sub | Flag to tell whether dns zone is in different sub or not. | `bool` | `false` | no |
| enable | Flag to control module creation. | `bool` | `true` | no |
| enable\_content\_trust | Boolean value to enable or disable Content trust in Azure Container Registry | `bool` | `true` | no |
| enable\_diagnostic | Flag to control diagnostic setting resource creation. | `bool` | `true` | no |
| enable\_private\_endpoint | Manages a Private Endpoint to Azure Container Registry | `bool` | `true` | no |
| enable\_rotation\_policy | Whether to enable rotation policy or not | `bool` | `false` | no |
| encryption | n/a | `bool` | `false` | no |
| environment | Environment (e.g. `prod`, `dev`, `staging`). | `string` | `""` | no |
| existing\_private\_dns\_zone | Name of the existing private DNS zone | `string` | `null` | no |
| existing\_private\_dns\_zone\_id | ID of existing private dns zone. To be used in dns configuration group in private endpoint. | `list(any)` | `null` | no |
| existing\_private\_dns\_zone\_resource\_group\_name | The name of the existing resource group | `string` | `null` | no |
| georeplications | A list of Azure locations where the container registry should be geo-replicated | <pre>list(object({<br>    location                = string<br>    zone_redundancy_enabled = optional(bool)<br>  }))</pre> | `[]` | no |
| identity\_ids | Specifies a list of user managed identity ids to be assigned. This is required when `type` is set to `UserAssigned` or `SystemAssigned, UserAssigned` | `list(string)` | `null` | no |
| key\_vault\_id | n/a | `string` | `null` | no |
| key\_vault\_rbac\_auth\_enabled | n/a | `bool` | `true` | no |
| label\_order | Label order, e.g. sequence of application name and environment `name`,`environment`,'attribute' [`webserver`,`qa`,`devops`,`public`,] . | `list(any)` | `[]` | no |
| location | The location/region to keep all your network resources. To get the list of all locations with table format from azure cli, run 'az account list-locations -o table' | `string` | `null` | no |
| log\_analytics\_workspace\_id | log\_analytics\_workspace\_id | `string` | `null` | no |
| log\_enabled | Is this Diagnostic Log enabled? Defaults to true. | `string` | `true` | no |
| managedby | ManagedBy, eg ''. | `string` | `""` | no |
| metric\_enabled | Is this Diagnostic Metric enabled? Defaults to True. | `bool` | `true` | no |
| multi\_sub\_vnet\_link | Flag to control creation of vnet link for dns zone in different subscription | `bool` | `false` | no |
| name | Name  (e.g. `app` or `cluster`). | `string` | `""` | no |
| network\_rule\_set | Manage network rules for Azure Container Registries | <pre>object({<br>    default_action = optional(string)<br>    ip_rule = optional(list(object({<br>      ip_range = string<br>    })))<br>    virtual_network = optional(list(object({<br>      subnet_id = string<br>    })))<br>  })</pre> | `null` | no |
| private\_dns\_name | n/a | `string` | `"privatelink.azurecr.io"` | no |
| private\_dns\_zone\_vnet\_link\_registration\_enabled | (Optional) Is auto-registration of virtual machine records in the virtual network in the Private DNS zone enabled? | `bool` | `true` | no |
| public\_network\_access\_enabled | To denied public access | `bool` | `false` | no |
| repository | Terraform current module repo | `string` | `""` | no |
| resource\_group\_name | A container that holds related resources for an Azure solution | `string` | `null` | no |
| retention\_policy | Set a retention policy for untagged manifests | <pre>object({<br>    days    = optional(number)<br>    enabled = optional(bool)<br>  })</pre> | <pre>{<br>  "days": 10,<br>  "enabled": true<br>}</pre> | no |
| same\_vnet | Variable to be set when multiple acr having common DNS in same vnet. | `bool` | `false` | no |
| scope\_map | Manages an Azure Container Registry scope map. Scope Maps are a preview feature only available in Premium SKU Container registries. | <pre>map(object({<br>    actions = list(string)<br>  }))</pre> | `null` | no |
| storage\_account\_id | Storage account id to pass it to destination details of diagnostic\_setting. | `string` | `null` | no |
| subnet\_id | Subnet to be used for private endpoint | `string` | `null` | no |
| virtual\_network\_id | Virtual Network to be used for private endpoint | `string` | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| container\_registry\_admin\_password | The Username associated with the Container Registry Admin account - if the admin account is enabled. |
| container\_registry\_admin\_username | The Username associated with the Container Registry Admin account - if the admin account is enabled. |
| container\_registry\_id | The ID of the Container Registry |
| container\_registry\_identity\_principal\_id | The Principal ID for the Service Principal associated with the Managed Service Identity of this Container Registry |
| container\_registry\_identity\_tenant\_id | The Tenant ID for the Service Principal associated with the Managed Service Identity of this Container Registry |
| container\_registry\_login\_server | The URL that can be used to log into the container registry |
| container\_registry\_private\_dns\_zone\_domain | DNS zone name of Azure Container Registry Private endpoints dns name records |
| container\_registry\_private\_endpoint | The ID of the Azure Container Registry Private Endpoint |
| container\_registry\_scope\_map\_id | The ID of the Container Registry scope map |
| container\_registry\_token\_id | The ID of the Container Registry token |
| container\_registry\_webhook\_id | The ID of the Container Registry Webhook |
| private\_dns\_zone\_id | ID of private dns zone. To be used when there is existing dns zone and id is to be passed in private endpoint dns configuration group. |




## Testing
In this module testing is performed with [terratest](https://github.com/gruntwork-io/terratest) and it creates a small piece of infrastructure, matches the output like ARN, ID and Tags name etc and destroy infrastructure in your AWS account. This testing is written in GO, so you need a [GO environment](https://golang.org/doc/install) in your system. 

You need to run the following command in the testing folder:
```hcl
  go test -run Test
```



## Feedback 
If you come accross a bug or have any feedback, please log it in our [issue tracker](https://github.com/clouddrove/terraform-azure-acr/issues), or feel free to drop us an email at [hello@clouddrove.com](mailto:hello@clouddrove.com).

If you have found it worth your time, go ahead and give us a ★ on [our GitHub](https://github.com/clouddrove/terraform-azure-acr)!

## About us

At [CloudDrove][website], we offer expert guidance, implementation support and services to help organisations accelerate their journey to the cloud. Our services include docker and container orchestration, cloud migration and adoption, infrastructure automation, application modernisation and remediation, and performance engineering.

<p align="center">We are <b> The Cloud Experts!</b></p>
<hr />
<p align="center">We ❤️  <a href="https://github.com/clouddrove">Open Source</a> and you can check out <a href="https://github.com/clouddrove">our other modules</a> to get help with your new Cloud ideas.</p>

  [website]: https://clouddrove.com
  [github]: https://github.com/clouddrove
  [linkedin]: https://cpco.io/linkedin
  [twitter]: https://twitter.com/clouddrove/
  [email]: https://clouddrove.com/contact-us.html
  [terraform_modules]: https://github.com/clouddrove?utf8=%E2%9C%93&q=terraform-&type=&language=
